<!DOCTYPE html><html><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><link rel="shortcut icon" type="image/png" href="data:image/png;base64,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"/><link rel="preload" href="/myblog/component---src-layouts-index-js-c1e083e7d85dd0aca005.js" as="script"/><link rel="preload" href="/myblog/component---src-templates-blog-post-js-55b2a1a99d1ea213b953.js" as="script"/><link rel="preload" href="/myblog/path---posts-1-90166e225d03eda6390c.js" as="script"/><link rel="preload" href="/myblog/app-df37403cdd0e6ac7ebee.js" as="script"/><link rel="preload" href="/myblog/commons-68aad81503ae45628ade.js" as="script"/><script id="webpack-manifest">/*<![CDATA[*/window.webpackManifest={"231608221292675":"app-df37403cdd0e6ac7ebee.js","107818501498521":"component---src-templates-blog-post-js-55b2a1a99d1ea213b953.js","263791100135453":"component---src-pages-about-js-ff45d29fd778b5a39075.js","35783957827783":"component---src-pages-index-js-31d5d9c1c3bd56028ef0.js","60335399758886":"path----557518bd178906f8d58a.js","81878219163735":"path---posts-3-65ce2f5b9207722d610a.js","216243879586913":"path---posts-2-f92f30ac7d2d8cb243fe.js","91246642375014":"path---posts-1-90166e225d03eda6390c.js","123118983598882":"path---posts-4-0542fcb9ca1a645193f6.js","4876863402267":"path---posts-5-1c348bc4f0bbbffb828e.js","106140644916941":"path---posts-6-654c88b5731d540ed597.js","130752015456929":"path---posts-7-f6ed77d92a2e941ca489.js","93923592088315":"path---posts-8-7cce6f2a475c28aa3699.js","20147626466865":"path---posts-9-2fdebe67865042412f7c.js","142656853184902":"path---posts-10-e905f65afb319157e449.js","244307437753867":"path---posts-11-331f34b2f3e246a6f382.js","279941687692024":"path---posts-12-a0324a2f6994102c920b.js","273950069227526":"path---about-a0e39f21c11f6a62c5ab.js","142629428675168":"path---index-e5d9b4ee3e73f7979f72.js","114276838955818":"component---src-layouts-index-js-c1e083e7d85dd0aca005.js"}/*]]>*/</script><style type="text/css" data-styled-components="kNnBpQ iKSQLe djlcST ZZrCW cDUvTM iLZaUK jorVQO" data-styled-components-is-local="true">/* sc-component-id: sc-bdVaJa */

.kNnBpQ{height:100vh;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;}
/* sc-component-id: sc-bwzfXH */

.djlcST{-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;position:relative;}
/* sc-component-id: sc-htpNat */

.ZZrCW{position:absolute;top:0;left:0;right:0;bottom:0;}
/* sc-component-id: sc-bxivhb */

.iKSQLe{line-height:40px;padding:10px;background:#00bcd4;}.iKSQLe a{color:white;}
/* sc-component-id: sc-ifAKCX */

.jorVQO{background:#00bcd4;padding:28px;color:white;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;}.jorVQO a{color:white;display:block;padding:0px;}
/* sc-component-id: sc-EHOje */

.cDUvTM{height:100%;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;padding-top:20px;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;}.cDUvTM .markdown-content{padding:20px;-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;}
/* sc-component-id: sc-bZQynM */

.iLZaUK{font-size:20px;text-align:center;font-weight:600px;}
</style><script>/*<![CDATA[*/!function(e,t,r){function n(){for(;d[0]&&"loaded"==d[0][f];)c=d.shift(),c[o]=!i.parentNode.insertBefore(c,i)}for(var s,a,c,d=[],i=e.scripts[0],o="onreadystatechange",f="readyState";s=r.shift();)a=e.createElement(t),"async"in i?(a.async=!1,e.head.appendChild(a)):i[f]?(d.push(a),a[o]=n):e.write("<"+t+' src="'+s+'" defer></'+t+">"),a.src=s}(document,"script",["/myblog/commons-68aad81503ae45628ade.js","/myblog/app-df37403cdd0e6ac7ebee.js","/myblog/path---posts-1-90166e225d03eda6390c.js","/myblog/component---src-templates-blog-post-js-55b2a1a99d1ea213b953.js","/myblog/component---src-layouts-index-js-c1e083e7d85dd0aca005.js"])/*]]>*/</script><style id="gatsby-inlined-css">code[class*=language-],pre[class*=language-]{color:#657b83;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]::-moz-selection,code[class*=language-] ::-moz-selection,pre[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection{background:#073642}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{background:#073642}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto;border-radius:.3em}:not(pre)>code[class*=language-],pre[class*=language-]{background-color:#fdf6e3}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#93a1a1}.token.punctuation{color:#586e75}.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#268bd2}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string,.token.url{color:#2aa198}.token.entity{color:#657b83;background:#eee8d5}.token.atrule,.token.attr-value,.token.keyword{color:#859900}.token.function{color:#b58900}.token.important,.token.regex,.token.variable{color:#cb4b16}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}body{margin:0}a{text-decoration:none}*{box-sizing:border-box}</style></head><body><div id="___gatsby"><div class="sc-bdVaJa kNnBpQ" data-reactroot="" data-reactid="1" data-react-checksum="-684521721"><div class="sc-bxivhb iKSQLe" data-reactid="2"><a href="/myblog/" data-reactid="3">首页</a></div><div class="sc-bwzfXH djlcST" data-reactid="4"><div class="sc-htpNat ZZrCW" data-reactid="5"><div class="sc-EHOje cDUvTM" data-reactid="6"><!-- react-empty: 7 --><div class="sc-bZQynM iLZaUK" data-reactid="8">无编码利用协同算法实现个性化推荐</div><div class="markdown-content" data-reactid="9"><h2>目标</h2>
<p>根据昨天的URL上报数据生成ALS模型。之后将模型加载到流式计算中，对实时URL的访问用户进行内容推荐。整个流程只需要你写写SQL（做解析），弄弄配置就搞定。</p>
<h2>资源准备</h2>
<ul>
<li>下载 <a href="http://spark.apache.org/downloads.html">spark 1.6</a></li>
<li>
<p>下载 StreamingPro 算法版</p>
<blockquote>
<p>链接:  <a href="http://share.weiyun.com/7c4b806011dc4e03d39279eafae916d7">http://share.weiyun.com/7c4b806011dc4e03d39279eafae916d7</a></p>
</blockquote>
</li>
</ul>
<h2>模型训练</h2>
<p> 首先我们拷贝一份配置文件  <a href="https://gist.github.com/allwefantasy/2170f67c9e1e453604e2e76923ee65dc">als-training</a>，我在配置文件里模拟了一些数据，假设是一些URL，大体如下，表示itemId 为2的文章被userId=1的用户访问了。</p>
<div class="gatsby-highlight">
      <pre class="language-none"><code>http://123.com/path?userId=1&itemId=2</code></pre>
      </div>
<p>之后的SQL就是抽取出userid 和itemId，然后得到一个包含label, features 的表。在StreamingPro中，所有的的算法的输入都会遵循这个规范。对于ALS算法而言，label 表示userId, features则是userId,ItemId,rating 三个按逗号拼接的字符串。对于回归类算法，则是逗号拼接的数字。</p>
<p>最后通过组件AlgorithmOutputCompositor 完成模型训练。</p>
<div class="gatsby-highlight">
      <pre class="language-js"><code><span class="token punctuation">{</span>
        <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"streaming.core.compositor.spark.output.AlgorithmOutputCompositor"</span><span class="token punctuation">,</span>
        <span class="token string">"params"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{</span>
            <span class="token string">"path"</span><span class="token punctuation">:</span> <span class="token string">"/tmp/als_log"</span><span class="token punctuation">,</span>
            <span class="token string">"algorithm"</span><span class="token punctuation">:</span> <span class="token string">"als"</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            <span class="token string">"rank"</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
            <span class="token string">"alpha"</span><span class="token punctuation">:</span> <span class="token number">1.0</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
</code></pre>
      </div>
<p>path表示输出路径。 algorithm 表示算法。目前只支持 als,lr(线性回归),lr2（逻辑回归）三种算法。后续会不断添加。</p>
<p>第二组参数则是对应算法的一些配置参数。你可以配置多组，算法自动回选择最优的一组参数得到模型，并且保存到对应的path路径下。</p>
<p>你可以直接运行得到结果：</p>
<div class="gatsby-highlight">
      <pre class="language-none"><code>./bin/spark-submit   \
--class streaming.core.StreamingApp \
--master local[2] \
/tmp/streamingpro-0.3.2-SNAPSHOT-online-mllib-1.6.1.jar  \
-streaming.name test \
-streaming.platform spark  \
-streaming.job.file.path file://tmp/strategy.v2.json </code></pre>
      </div>
<h2>推荐预测</h2>
<p>接着我们要给指定的用户进行推荐。参看 <a href="https://gist.github.com/allwefantasy/c0d3cf678356515e35cf6d4e0529038b">als-predict</a>。</p>
<p>解析出用户的逻辑是和上面的是一样的。里面的核心模块是：</p>
<div class="gatsby-highlight">
      <pre class="language-js"><code><span class="token punctuation">{</span>
        <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"streaming.core.compositor.spark.transformation.AlgorithmCompositor"</span><span class="token punctuation">,</span>
        <span class="token string">"params"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{</span>
            <span class="token string">"path"</span><span class="token punctuation">:</span> <span class="token string">"file:///tmp/als_log"</span><span class="token punctuation">,</span>
            <span class="token string">"algorithm"</span><span class="token punctuation">:</span> <span class="token string">"als"</span><span class="token punctuation">,</span>
            <span class="token string">"outputTableName"</span><span class="token punctuation">:</span> <span class="token string">"test4"</span><span class="token punctuation">,</span>
            <span class="token string">"recommendUsersForProductsNum"</span><span class="token punctuation">:</span> <span class="token number">1</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
</code></pre>
      </div>
<p>path 是模型文件所在的位置。recommendUsersForProductsNum 表示对每个用户推荐多少内容。outputTableName是输出的表，
方便后续继续操作，比如存储到Redis或者数据库中，方便前端程序做调用。</p>
<p>大家讲上面的运行脚本里的配置文件路径调整下，就可以运行起来，看到运行结果，比如我这里的结果是：</p>
<div class="gatsby-highlight">
      <pre class="language-none"><code>+----+----+--------------------+
|user|item|             ratings|
+----+----+--------------------+
|   3|   2|[[2,3,0.900332472...|
|   2|   3|[[2,2,0.900333589...|
|   2|   2|[[2,2,0.900333589...|
+----+----+--------------------+</code></pre>
      </div>
<p>你可以输入到任何你感兴趣的系统中，StreamingPro目前支持ES,Parquet等Spark已经支持的格式作为输出。</p>
<h2>在流式计算中进行数据推荐</h2>
<p>参看 <a href="https://gist.github.com/allwefantasy/fc8280006f466ddc860c842ac8abf2c0">als-streaming-predict</a>,将所有的包名前缀从</p>
<div class="gatsby-highlight">
      <pre class="language-none"><code>streaming.core.compositor.spark
转换为
streaming.core.compositor.spark.streaming</code></pre>
      </div>
<p>即可支持流式。运行脚本如下：</p>
<div class="gatsby-highlight">
      <pre class="language-none"><code>./bin/spark-submit   \
--class streaming.core.StreamingApp \
--name "join"  \
--master local[2] \
/tmp/streamingpro-0.3.2-SNAPSHOT-online-mllib-1.6.1.jar  \
-streaming.name test \
-streaming.job.file.path file://tmp/strategy.v2.json </code></pre>
      </div>
<h2>总结</h2>
<p>在StreamingPro中，一个算法的模型训练，仅仅被看做一个特殊的存储。我们完全可以将对应的AlgothrimOutputCompositor换成 其他的输出源。</p>
<p>而对于数据的预测，我们仅仅是把它看做一个数据Transformer，根据进来的数据，新生成一个prediction字段。</p>
<p>无论是模型训练还是预测，都是基于SQL流来完成的，完美的融入到了数据的流程当中。</p>
<h2>附录</h2>
<p>感兴趣实现的，可以参考 <a href="https://github.com/allwefantasy/streamingpro/tree/mllib/src/main/java/org/apache/spark/ml">代码</a></p></div><div class="sc-ifAKCX jorVQO" data-reactid="10"><div data-reactid="11"></div><div data-reactid="12"><a href="/myblog/posts/2" data-reactid="13">Next</a></div></div></div></div></div></div></div></body></html>