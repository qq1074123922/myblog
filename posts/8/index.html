<!DOCTYPE html><html><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><link rel="shortcut icon" type="image/png" href="data:image/png;base64,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"/><link rel="preload" href="/myblog/component---src-layouts-index-js-c1e083e7d85dd0aca005.js" as="script"/><link rel="preload" href="/myblog/component---src-templates-blog-post-js-55b2a1a99d1ea213b953.js" as="script"/><link rel="preload" href="/myblog/path---posts-8-7cce6f2a475c28aa3699.js" as="script"/><link rel="preload" href="/myblog/app-df37403cdd0e6ac7ebee.js" as="script"/><link rel="preload" href="/myblog/commons-68aad81503ae45628ade.js" as="script"/><script id="webpack-manifest">/*<![CDATA[*/window.webpackManifest={"231608221292675":"app-df37403cdd0e6ac7ebee.js","107818501498521":"component---src-templates-blog-post-js-55b2a1a99d1ea213b953.js","263791100135453":"component---src-pages-about-js-ff45d29fd778b5a39075.js","35783957827783":"component---src-pages-index-js-31d5d9c1c3bd56028ef0.js","60335399758886":"path----557518bd178906f8d58a.js","81878219163735":"path---posts-3-65ce2f5b9207722d610a.js","216243879586913":"path---posts-2-f92f30ac7d2d8cb243fe.js","91246642375014":"path---posts-1-90166e225d03eda6390c.js","123118983598882":"path---posts-4-0542fcb9ca1a645193f6.js","4876863402267":"path---posts-5-1c348bc4f0bbbffb828e.js","106140644916941":"path---posts-6-654c88b5731d540ed597.js","130752015456929":"path---posts-7-f6ed77d92a2e941ca489.js","93923592088315":"path---posts-8-7cce6f2a475c28aa3699.js","20147626466865":"path---posts-9-b20d26b952031219dcce.js","142656853184902":"path---posts-10-660bb478f0dd0283a544.js","244307437753867":"path---posts-11-64142ec9824c2a7d7728.js","279941687692024":"path---posts-12-6245c00f4a64b0b54a4f.js","273950069227526":"path---about-a0e39f21c11f6a62c5ab.js","142629428675168":"path---index-cd50a25afb7a8265271e.js","114276838955818":"component---src-layouts-index-js-c1e083e7d85dd0aca005.js"}/*]]>*/</script><style type="text/css" data-styled-components="kNnBpQ iKSQLe djlcST ZZrCW cDUvTM iLZaUK jorVQO" data-styled-components-is-local="true">/* sc-component-id: sc-bdVaJa */

.kNnBpQ{height:100vh;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;}
/* sc-component-id: sc-bwzfXH */

.djlcST{-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;position:relative;}
/* sc-component-id: sc-htpNat */

.ZZrCW{position:absolute;top:0;left:0;right:0;bottom:0;}
/* sc-component-id: sc-bxivhb */

.iKSQLe{line-height:40px;padding:10px;background:#00bcd4;}.iKSQLe a{color:white;}
/* sc-component-id: sc-ifAKCX */

.jorVQO{background:#00bcd4;padding:28px;color:white;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;}.jorVQO a{color:white;display:block;padding:0px;}
/* sc-component-id: sc-EHOje */

.cDUvTM{height:100%;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;padding-top:20px;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;}.cDUvTM .markdown-content{padding:20px;-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;}
/* sc-component-id: sc-bZQynM */

.iLZaUK{font-size:20px;text-align:center;font-weight:600px;}
</style><script>/*<![CDATA[*/!function(e,t,r){function n(){for(;d[0]&&"loaded"==d[0][f];)c=d.shift(),c[o]=!i.parentNode.insertBefore(c,i)}for(var s,a,c,d=[],i=e.scripts[0],o="onreadystatechange",f="readyState";s=r.shift();)a=e.createElement(t),"async"in i?(a.async=!1,e.head.appendChild(a)):i[f]?(d.push(a),a[o]=n):e.write("<"+t+' src="'+s+'" defer></'+t+">"),a.src=s}(document,"script",["/myblog/commons-68aad81503ae45628ade.js","/myblog/app-df37403cdd0e6ac7ebee.js","/myblog/path---posts-8-7cce6f2a475c28aa3699.js","/myblog/component---src-templates-blog-post-js-55b2a1a99d1ea213b953.js","/myblog/component---src-layouts-index-js-c1e083e7d85dd0aca005.js"])/*]]>*/</script><style id="gatsby-inlined-css">code[class*=language-],pre[class*=language-]{color:#657b83;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]::-moz-selection,code[class*=language-] ::-moz-selection,pre[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection{background:#073642}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{background:#073642}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto;border-radius:.3em}:not(pre)>code[class*=language-],pre[class*=language-]{background-color:#fdf6e3}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#93a1a1}.token.punctuation{color:#586e75}.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#268bd2}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string,.token.url{color:#2aa198}.token.entity{color:#657b83;background:#eee8d5}.token.atrule,.token.attr-value,.token.keyword{color:#859900}.token.function{color:#b58900}.token.important,.token.regex,.token.variable{color:#cb4b16}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}body{margin:0}a{text-decoration:none}*{box-sizing:border-box}</style></head><body><div id="___gatsby"><div class="sc-bdVaJa kNnBpQ" data-reactroot="" data-reactid="1" data-react-checksum="-559544728"><div class="sc-bxivhb iKSQLe" data-reactid="2"><a href="/myblog/" data-reactid="3">首页</a></div><div class="sc-bwzfXH djlcST" data-reactid="4"><div class="sc-htpNat ZZrCW" data-reactid="5"><div class="sc-EHOje cDUvTM" data-reactid="6"><!-- react-empty: 7 --><div class="sc-bZQynM iLZaUK" data-reactid="8">spark常见问题解决方法</div><div class="markdown-content" data-reactid="9"><div class="post-body" itemprop="articleBody">
<p>对于Spark程序优化，应从如下几点进行：
  <code>1.</code> 通过监控CPU、内存、网络、IO、GC、应用指标等数据，切实找到系统的瓶颈点。
  <code>2.</code> 统筹全局，制定相应的解决方案，解决问题的思路是否清晰准确很重要，切勿『头疼医头，脚疼医脚』，应总体考虑把握。
  <code>3.</code> 了解一些技术的背景知识，对于每次优化尽量做得彻底些，多进行总结。
  <code>4.</code> 程序优化通常从Stage/Cache/Partition、资源、内存/GC的优化。</p>
<p><strong>1.</strong> spark运行时报错：Shutdown hook called before final status was reported.
解决方法：程序存在错误，将日志down下来查看具体原因！down日志命令：<code>yarn logs -applicationId app_id</code></p>
<p><strong>2.</strong> Spark性能优化的9大问题及其解决方案<a href="http://book.51cto.com/art/201409/453045.htm">http://book.51cto.com/art/201409/453045.htm</a>
Spark程序优化所需要关注的几个关键点——最主要的是数据序列化和内存优化  </p>
<p><code>*问题1</code>：reduce task数目不合适
<code>解决方法</code>：需根据实际情况调节默认配置，调整方式是修改参数spark.default.parallelism。通常，reduce数目设置为core数目的2到3倍。数量太大，造成很多小任务，增加启动任务的开销；数目太少，*任务运行缓慢。</p>
<p><code>*问题2</code>：shuffle磁盘IO时间长
<code>解决方法</code>：设置spark.local.dir为多个磁盘，并设置磁盘为IO速度快的磁盘，通过增加IO来优化shuffle性能；</p>
<p><code>*问题3</code>：map|reduce数量大，造成shuffle小文件数目多
<code>解决方法</code>：默认情况下shuffle文件数目为map tasks * reduce tasks. 通过设置spark.shuffle.consolidateFiles为true，来合并shuffle中间文件，此时文件数为reduce tasks数目；</p>
<p><code>*问题4</code>：序列化时间长、结果大
<code>解决方法</code>：Spark默认使.用JDK.自带的ObjectOutputStream，这种方式产生的结果大、CPU处理时间长，可以通过设置spark.serializer为org.apache.spark.serializer.KryoSerializer。另外如果结果已经很大，可以使用广播变量；</p>
<p><code>*问题5</code>：单条记录消耗大
<code>解决方法</code>：使用mapPartition替换map，mapPartition是对每个Partition进行计算，而map是对partition中的每条记录进行计算；</p>
<p><code>*问题6</code>: collect输出大量结果时速度慢
<code>解决方式</code>：collect源码中是把所有的结果以一个Array的方式放在内存中，可以直接输出到分布式?文件系统，然后查看文件系统中的内容；</p>
<p><code>*问题7</code>: 任务执行速度倾斜
<code>解决方式</code>：如果是数据倾斜，一般是partition key取的不好，可以考虑其它的并行处理方式 ，并在中间加上aggregation操作；如果是Worker倾斜，例如在某些worker上的executor执行缓慢，可以通过设置spark.speculation=true 把那些持续慢的节点去掉；</p>
<p><code>*问题8</code>: 通过多步骤的RDD操作后有很多空任务或者小任务产生
<code>解决方式</code>：使用coalesce或repartition去减少RDD中partition数量；</p>
<p><code>*问题9</code>：Spark Streaming吞吐量不高
<code>解决方式</code>：可以设置spark.streaming.concurrentJobs</p>
<div class="gatsby-highlight">
      <pre class="language-js"><code><span class="token operator">**</span><span class="token number">3</span><span class="token punctuation">.</span><span class="token operator">**</span> intellij idea直接编译spark源码及问题解决<span class="token punctuation">:</span>
<span class="token template-string"><span class="token string">`*`</span></span> <span class="token punctuation">[</span>http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>blog<span class="token punctuation">.</span>csdn<span class="token punctuation">.</span>net<span class="token operator">/</span>tanglizhe1105<span class="token operator">/</span>article<span class="token operator">/</span>details<span class="token operator">/</span><span class="token number">50530104</span><span class="token punctuation">]</span><span class="token punctuation">(</span>http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>blog<span class="token punctuation">.</span>csdn<span class="token punctuation">.</span>net<span class="token operator">/</span>tanglizhe1105<span class="token operator">/</span>article<span class="token operator">/</span>details<span class="token operator">/</span><span class="token number">50530104</span><span class="token punctuation">)</span>
<span class="token template-string"><span class="token string">`*`</span></span> <span class="token punctuation">[</span>http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>stackoverflow<span class="token punctuation">.</span>com<span class="token operator">/</span>questions<span class="token operator">/</span><span class="token number">18920334</span><span class="token operator">/</span>output<span class="token operator">-</span>path<span class="token operator">-</span>is<span class="token operator">-</span>shared<span class="token operator">-</span>between<span class="token operator">-</span>the<span class="token operator">-</span>same<span class="token operator">-</span>module<span class="token operator">-</span>error<span class="token punctuation">]</span><span class="token punctuation">(</span>http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>stackoverflow<span class="token punctuation">.</span>com<span class="token operator">/</span>questions<span class="token operator">/</span><span class="token number">18920334</span><span class="token operator">/</span>output<span class="token operator">-</span>path<span class="token operator">-</span>is<span class="token operator">-</span>shared<span class="token operator">-</span>between<span class="token operator">-</span>the<span class="token operator">-</span>same<span class="token operator">-</span>module<span class="token operator">-</span>error<span class="token punctuation">)</span>

<span class="token operator">&lt;</span>figure <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"highlight scala"</span><span class="token operator">></span><span class="token operator">&lt;</span>table<span class="token operator">></span><span class="token operator">&lt;</span>tbody<span class="token operator">></span><span class="token operator">&lt;</span>tr<span class="token operator">></span><span class="token operator">&lt;</span>td <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"gutter"</span><span class="token operator">></span><span class="token operator">&lt;</span>pre<span class="token operator">></span><span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"line"</span><span class="token operator">></span><span class="token number">1</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"line"</span><span class="token operator">></span><span class="token number">2</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>pre<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>td<span class="token operator">></span><span class="token operator">&lt;</span>td <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"code"</span><span class="token operator">></span><span class="token operator">&lt;</span>pre<span class="token operator">></span><span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"line"</span><span class="token operator">></span><span class="token operator">&lt;</span>span <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"type"</span><span class="token operator">></span>Spark<span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">></span>编译：clean <span class="token operator">&lt;</span>span <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"keyword"</span><span class="token operator">></span><span class="token keyword">package</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">></span> <span class="token operator">-</span><span class="token operator">&lt;</span>span <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"type"</span><span class="token operator">></span>Dmaven<span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">></span><span class="token punctuation">.</span>test<span class="token punctuation">.</span>skip<span class="token operator">=</span><span class="token operator">&lt;</span>span <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"literal"</span><span class="token operator">></span><span class="token boolean">true</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"line"</span><span class="token operator">></span>参数：<span class="token operator">-</span><span class="token operator">&lt;</span>span <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"type"</span><span class="token operator">></span>Xmx2g<span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">></span> <span class="token operator">-</span><span class="token operator">&lt;</span>span <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"type"</span><span class="token operator">></span>XX<span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">></span><span class="token punctuation">:</span><span class="token operator">&lt;</span>span <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"type"</span><span class="token operator">></span>MaxPermSize<span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">>=</span><span class="token operator">&lt;</span>span <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"number"</span><span class="token operator">></span><span class="token number">512</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">></span>M <span class="token operator">-</span><span class="token operator">&lt;</span>span <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"type"</span><span class="token operator">></span>XX<span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">></span><span class="token punctuation">:</span><span class="token operator">&lt;</span>span <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"type"</span><span class="token operator">></span>ReservedCodeCacheSize<span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">>=</span><span class="token operator">&lt;</span>span <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"number"</span><span class="token operator">></span><span class="token number">512</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">></span>m<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>pre<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>td<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>tr<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>tbody<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>table<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>figure<span class="token operator">></span>
</code></pre>
      </div>
<p><strong>4.</strong> import Spark source code into intellj, build Error: not found: type SparkFlumeProtocol and EventBatch
<a href="http://stackoverflow.com/questions/33311794/import-spark-source-code-into-intellj-build-error-not-found-type-sparkflumepr">http://stackoverflow.com/questions/33311794/import-spark-source-code-into-intellj-build-error-not-found-type-sparkflumepr</a> </p>
<div align="center">[![1.1](/uploads/spark/spark_complie_config.png)](/uploads/spark/spark_complie_config.png)</div>
<p><strong>5.</strong> 整理对Spark SQL的理解：<a href="http://www.aboutyun.com/thread-8575-1-1.html">http://www.aboutyun.com/thread-8575-1-1.html</a></p>
<p><strong>6.</strong> Spark GBDT实现方式：spark gbdt的实现基于：J.H. Friedman.  “Stochastic Gradient Boosting.” 1999.spark。
  <code>1)</code> gbdt使用一般的残差更新方式，利用残差（梯度方向）更新样本数据集，做为下棵树模型训练的样本</p>
<figure class="highlight arduino"><table><tbody><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">data = input.<span class="built_in">map</span>(<span class="built_in">point</span> =&gt; LabeledPoint(-loss.gradient(partialModel, <span class="built_in">point</span>),<span class="built_in">point</span>.features))</div></pre></td></tr></tbody></table></figure>
<p>  <code>2)</code> 建树过程用variance作为split准则, xgboost对目标函数进行变换，每轮建树的过程用gradient和hessian计算gain作为split准则
  <code>3)</code> 算法性能（效率、支持数据量）
  <code>4)</code> 算法结果的一致性</p>
<p><strong>7.</strong> UDAF（User- Defined Aggregation Funcation）：<a href="http://p-x1984.iteye.com/blog/1156392">http://p-x1984.iteye.com/blog/1156392</a>
Hive自定义UDF和聚合函数UDAF：<a href="http://computerdragon.blog.51cto.com/6235984/1288567">http://computerdragon.blog.51cto.com/6235984/1288567</a>
Hive自定义UDF和聚合函数UDAF：<a href="http://www.tuicool.com/articles/mYZ7R3">http://www.tuicool.com/articles/mYZ7R3</a></p>
<p><strong>8.</strong> java.lang.NoSuchMethodException: java.util.Set.<init>()
<a href="mailto:http://mail-archives.apache.org/mod_mbox/hive-user/201307.mbox/%3CCE1CA41C.1176E%25rdm@baynote.com%3E">http://mail-archives.apache.org/mod_mbox/hive-user/201307.mbox/%3CCE1CA41C.1176E%25rdm@baynote.com%3E</a></init></p>
<p><strong>9.</strong> Hive可以允许用户编写自己定义的函数UDF，来在查询中使用。Hive中有3种UDF：
  <code>* UDF</code>：操作单个数据行，产生单个数据行;
  <code>* UDAF</code>：操作多个数据行，产生一个数据行。
  <code>* UDTF</code>：操作一个数据行，产生多个数据行一个表作为输出。  </p>
<p><strong>10.</strong> Hive查询数据时，有些聚类函数在HQL没有自带，需要用户自定义实现UDTF。
实现用户自定义聚合函数: Sum, Average…… n – 1
  <code>10.1.</code> 必须import org.apache.hadoop.hive.ql.exec.UDAF和org.apache.hadoop.hive.ql.exec.UDAFEvaluator。
  <code>10.2.</code> 函数类需要继承UDAF类，内部类Evaluator实UDAFEvaluator接口。
  <code>10.3.</code> Evaluator需要实现init、iterate、terminatePartial、merge、terminate这几个函数。
  <code>10.3.1.</code> init函数实现接口UDAFEvaluator的init函数。
  <code>10.3.2.</code> iterate接收传入的参数，并进行内部的轮转。其返回类型为boolean。
  <code>10.3.3.</code> terminatePartial无参数，其为iterate函数轮转结束后，返回轮转数据，terminatePartial类于hadoop的Combiner。
  <code>10.3.4.</code> merge接收terminatePartial的返回结果，进行数据merge操作，其返回类型为boolean。
  <code>10.3.5.</code> terminate返回最终的聚集函数结果。</p>
<p><strong>11.</strong> Apache Zeppelin编译安装：<a href="http://www.iteblog.com/archives/1573">http://www.iteblog.com/archives/1573</a>
Apache Zeppelin installation grunt build error：<a href="http://stackoverflow.com/questions/33352309/apache-zeppelin-installation-grunt-build-error?rq=1">http://stackoverflow.com/questions/33352309/apache-zeppelin-installation-grunt-build-error?rq=1</a>
<code>解决方案</code>：进入web模块npm install</p>
<div class="gatsby-highlight">
      <pre class="language-js"><code><span class="token operator">**</span><span class="token number">12</span><span class="token punctuation">.</span><span class="token operator">**</span> Spark源码编译遇到的问题解决：<span class="token punctuation">[</span>http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>tuicool<span class="token punctuation">.</span>com<span class="token operator">/</span>articles<span class="token operator">/</span>NBVvai<span class="token punctuation">]</span><span class="token punctuation">(</span>http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>tuicool<span class="token punctuation">.</span>com<span class="token operator">/</span>articles<span class="token operator">/</span>NBVvai<span class="token punctuation">)</span>
内存不够，这个错误是因为编译的时候内存不够导致的，可以在编译的时候加大内存。

<span class="token operator">&lt;</span>figure <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"highlight shell"</span><span class="token operator">></span><span class="token operator">&lt;</span>table<span class="token operator">></span><span class="token operator">&lt;</span>tbody<span class="token operator">></span><span class="token operator">&lt;</span>tr<span class="token operator">></span><span class="token operator">&lt;</span>td <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"gutter"</span><span class="token operator">></span><span class="token operator">&lt;</span>pre<span class="token operator">></span><span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"line"</span><span class="token operator">></span><span class="token number">1</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"line"</span><span class="token operator">></span><span class="token number">2</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"line"</span><span class="token operator">></span><span class="token number">3</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"line"</span><span class="token operator">></span><span class="token number">4</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"line"</span><span class="token operator">></span><span class="token number">5</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"line"</span><span class="token operator">></span><span class="token number">6</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"line"</span><span class="token operator">></span><span class="token number">7</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"line"</span><span class="token operator">></span><span class="token number">8</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"line"</span><span class="token operator">></span><span class="token number">9</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"line"</span><span class="token operator">></span><span class="token number">10</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>pre<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>td<span class="token operator">></span><span class="token operator">&lt;</span>td <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"code"</span><span class="token operator">></span><span class="token operator">&lt;</span>pre<span class="token operator">></span><span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"line"</span><span class="token operator">></span><span class="token punctuation">[</span>ERROR<span class="token punctuation">]</span> PermGen space <span class="token operator">-</span><span class="token operator">&amp;</span>gt<span class="token punctuation">;</span> <span class="token punctuation">[</span>Help <span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"line"</span><span class="token operator">></span><span class="token punctuation">[</span>ERROR<span class="token punctuation">]</span> <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"line"</span><span class="token operator">></span><span class="token punctuation">[</span>ERROR<span class="token punctuation">]</span> To see the full stack trace <span class="token keyword">of</span> the errors<span class="token punctuation">,</span>re<span class="token operator">-</span>run Maven <span class="token keyword">with</span> the <span class="token operator">-</span>e <span class="token keyword">switch</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"line"</span><span class="token operator">></span><span class="token punctuation">[</span>ERROR<span class="token punctuation">]</span> Re<span class="token operator">-</span>run Maven using the <span class="token operator">-</span>X <span class="token keyword">switch</span> to enable full debug logging<span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"line"</span><span class="token operator">></span><span class="token punctuation">[</span>ERROR<span class="token punctuation">]</span> <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"line"</span><span class="token operator">></span><span class="token punctuation">[</span>ERROR<span class="token punctuation">]</span> For more information about the errors and possible solutions<span class="token punctuation">,</span> <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"line"</span><span class="token operator">></span>please read the following articles<span class="token punctuation">:</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"line"</span><span class="token operator">></span><span class="token punctuation">[</span>ERROR<span class="token punctuation">]</span> <span class="token punctuation">[</span>Help <span class="token number">1</span><span class="token punctuation">]</span>http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>cwiki<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>org<span class="token operator">/</span>confluence<span class="token operator">/</span>display<span class="token operator">/</span>MAVEN<span class="token operator">/</span>OutOfMemoryError<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"line"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"line"</span><span class="token operator">></span><span class="token keyword">export</span> MAVEN_OPTS<span class="token operator">=</span><span class="token string">"-Xmx2g -XX:MaxPermSize=512M -XX:ReservedCodeCacheSize=512m"</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>pre<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>td<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>tr<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>tbody<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>table<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>figure<span class="token operator">></span>
</code></pre>
      </div>
<p><strong>13.</strong> Exception in thread “main” java.lang.UnsatisfiedLinkError: no jnind4j in java.library.path
I’m using a 64-Bit Java on Windows and still get the no jnind4j in java.library.path error
It may be that you have incompatible DLLs on your PATH. In order to tell DL4J to ignore those you have to add the following as a VM parameter (Run -> Edit Configurations -> VM Options in IntelliJ): <code>-Djava.library.path=""</code></p>
<p><strong>14.</strong> <code>spark2.0</code>本地运行源码报错解决办法：
  <code>14.1.</code> 修改对应pom中的依赖jar包，将scope级别由<code>provided</code>改为<code>compile</code>
  <code>14.2.</code> 运行类之前，去掉make选项；在运行vm设置中增加<code>-Dspark.master=local</code>
  <code>14.3.</code> Win7下运行spark example代码报错：</p>
<div class="gatsby-highlight">
      <pre class="language-none"><code>java.lang.IllegalArgumentException: java.net.URISyntaxException: Relative path in absolute URI: file:D:/SourceCode/spark-2.0.0/spark-warehouse`修改SQLConf类中WAREHOUSE_PATH变量，将file:前缀改为file:/或file:///
createWithDefault("file:/${system:user.dir}/spark-warehouse")</code></pre>
      </div>
<p>  <code>14.4.</code> local模式运行：<code>-Dspark.master=local</code></p>
<p><strong>15.</strong> Spark底层运行原理疑问？
  <code>*</code> SparkSession、SparkContext、SQLContext、HiveContext之间的关系与实现机制？
  <code>*</code> RDD、DataFrame、DataSet之间的区别与联系，实现原理？
  <code>*</code> Spark执行原理？
  <code>*</code> Spark SQL执行原理？
  <code>*</code> Spark中的常见设计模式？
  <code>*</code> Spark主要包括  调度与任务分配、I/O模块、通信控制模块、容错模块、Shuffle模块。
  <code>*</code> Spark 按照   ①应用  application  ②作业 job   ③ stage  ④ task 四个层次进行调度，采用经典的FIFO和FAIR等调度算法。</p>
<p><strong>16.</strong> 解决<code>Task not serializable Exception</code>错误
方法1：将RDD中的所有数据通过JDBC连接写入数据库，若使用map函数，可能要为每个元素都创建connection，这样开销很大，如果使用mapPartitions，那么只需要针对每个分区建立connection；mapPartitions处理后返回的是Iterator。
方法2：对未序列化的对象加@transisent引用，在进行网络通信时不对对象中的属性进行序列化</p>
<p><strong>17.</strong> 使用LZO过程会发现它有两种压缩编码可以使用，即LzoCodec和LzopCodec，下面说说它们区别：
  <code>17.1.</code> LzoCodec比LzopCodec更快， LzopCodec为了兼容LZOP程序添加了如 bytes signature, header等信息
  <code>17.2.</code> 如果使用 LzoCodec作为Reduce输出，则输出文件扩展名为”.lzo<em>deflate”，它无法被lzop读取；如果使用LzopCodec作为Reduce输出，则扩展名为”.lzo”，它可以被lzop读取
  <code>17.3.</code> 生成lzo index job的”DistributedLzoIndexer“无法为 LzoCodec，即 “.lzo</em>deflate”扩展名的文件创建index
  <code>17.4.</code> ”.lzo_deflate“文件无法作为MapReduce输入，”.LZO”文件则可以。
  <code>17.5.</code> 综上所述得出最佳实践：map输出的中间数据使用 LzoCodec，reduce输出使用 LzopCodec</p>
<p><strong>18.</strong> JVM线程池发展趋势：<a href="http://www.importnew.com/15082.html">http://www.importnew.com/15082.html</a>
对于传统线程池机制，一个强大的替代方案就是基于事件模型。这种基于事件的线程轮询/线程池/线程调度机制在函数式编程中很常见。关于这个概念的一个非常流行的实现是基于actor的系统（译者注：Scala的并发系统），Akka已成为其实际上的标准。（译者注：Akka，一种善于处理进程间通信的框架）</p>
<p><strong>19.</strong> 这个函数在func(“11”)调用时候正常,但是在执行func(11)或func(1.1)时候就会报error: type mismatch的错误.
<code>*</code> 针对特定的参数类型, 重载多个func函数,这个不难, 传统JAVA中的思路, 但是需要定义多个函数
<code>*</code> 使用超类型, 比如使用AnyVal,Any;这样的话比较麻烦,需要在函数中针对特定的逻辑做类型转化,从而进一步处理上面两个方法使用的是传统JAVA思路,虽然都可以解决该问题,但是缺点是不够简洁;在充满了语法糖的Scala中,针对类型转换提供了特有的implicit隐式转化的功能;</p>
<p><strong>20.</strong> org.apache.spark.shuffle.MetadataFetchFailedException: Missing an output location for shuffle
<code>解决方案</code>：这种问题一般发生在有大量shuffle操作的时候,task不断的failed,然后又重执行，一直循环下去，直到application失败。一般遇到这种问题提高executor内存即可,同时增加每个executor的cpu,这样不会减少task并行度。</p>
<p><strong>21.</strong> Spark ML PipeLine GBT/RF预测时报错，java.util.NoSuchElementException: key not found: 8.0
<code>错误原因</code>：由于GBT/RF模型输入setFeaturesCol，setLabelCol参数列名不一致导致。
<code>解决方案</code>：只保存训练算法模型，不保存PipeLineModel</p>
<p><strong>22.</strong> linux删除乱码文件，find . -inum 54263996 -exec rm {} -rf ;</p>
<p><strong>23.</strong> org.apache.spark.SparkException: Exception thrown in awaitResult
<code>set "spark.sql.broadcastTimeout" to increase the timeout</code></p>
<p><strong>24.</strong> Caused by: java.lang.RuntimeException: Failed to commit task
Caused by: org.apache.spark.executor.CommitDeniedException: attempt<em>201603251514</em>0218<em>m</em>000245_0: Not committed because the driver did not authorize commit
如果你比较了解spark中的stage是如何划分的，这个问题就比较简单了。一个Stage中包含的task过大，一般由于你的transform过程太长，因此driver给executor分发的task就会变的很大。所以解决这个问题我们可以通过拆分stage解决。也就是在执行过程中调用cache.count缓存一些中间数据从而切断过长的stage。</p>
<p><strong>25.</strong> Spark Streaming性能调优：<a href="https://www.iteblog.com/archives/1333">https://www.iteblog.com/archives/1333</a>
<strong>优化运行时间</strong>
| <code>增加并行度</code> 确保使用整个集群的资源，而不是把任务集中在几个特定的节点上。对于包含shuffle的操作，增加其并行度以确保更为充分地使用集群资源；
| <code>减少数据序列化</code> 反序列化的负担 Spark Streaming默认将接受到的数据序列化后存储，以减少内存的使用。但是序列化和反序列话需要更多的CPU时间，因此更加高效的序列化方式（Kryo）和自定义的系列化接口可以更高效地使用CPU；
| <code>设置合理的batch duration（批处理时间间隔）</code> 在Spark Streaming中，Spark会每隔batchDuration间隔时间提交一次job，Job之间有可能存在依赖关系，后面的Job必须确保前面的作业执行结束后才能提交。若前面的Job执行的时间超出了批处理时间间隔，那么后面的Job就无法按时提交，这样就会进一步拖延接下来的Job，造成后续Job的阻塞。因此设置一个合理的批处理间隔以确保作业能够在这个批处理间隔内结束时必须的；
| <code>减少因任务提交和分发所带来的负担</code> 通常情况下，Akka框架能够高效地确保任务及时分发，但是当批处理间隔非常小（500ms）时，提交和分发任务的延迟就变得不可接受了。使用Standalone和Coarse-grained Mesos模式通常会比使用Fine-grained   Mesos模式有更小的延迟。
| <code>缓存需要经常使用的数据</code> 调用rdd.cache()来缓存数据，加快数据处理  </p>
<p><strong>优化内存使用</strong>
| <code>控制batch size（批处理间隔内的数据量）</code> Spark Streaming会把批处理间隔内接收到的所有数据存放在Spark内部的可用内存区域中，因此必须确保当前节点Spark的可用内存中少能容纳这个批处理时间间隔内的所有数据，否则必须增加新的资源以提高集群的处理能力；
| <code>及时清理不再使用的数据</code> 前面讲到Spark Streaming会将接受的数据全部存储到内部可用内存区域中，因此对于处理过的不再需要的数据应及时清理，以确保Spark Streaming有富余的可用内存空间。通过设置合理的spark.cleaner.ttl【Deprecated】时长来及时清理超时的无用数据，这个参数需要小心设置以免后续操作中所需要的数据被超时错误处理，还可以配置选项spark.streaming.unpersist=true来更智能的持久化(unpersist)RDD，该配置使系统找出那些不需要经常保存的RDD，然后去持久化它们，这样可以减少spark rdd的内存使用，还可以改善垃圾回收行为；
| <code>观察及适当调整GC策略</code> GC会影响Job的正常运行，可能延长Job的执行时间，引起一系列不可预料的问题。观察GC的运行情况，采用不同的GC策略以进一步减小内存回收对Job运行的影响。
| <code>设备合理的CPU资源数</code></p>
<div class="gatsby-highlight">
      <pre class="language-none"><code></div></code></pre>
      </div></div><div class="sc-ifAKCX jorVQO" data-reactid="10"><div data-reactid="11"><a href="/myblog/posts/7" data-reactid="12">Prev</a></div><div data-reactid="13"><a href="/myblog/posts/9" data-reactid="14">Next</a></div></div></div></div></div></div></div></body></html>