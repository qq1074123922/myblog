<!DOCTYPE html><html><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><link rel="shortcut icon" type="image/png" href="data:image/png;base64,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"/><link rel="preload" href="/myblog/component---src-layouts-index-js-c1e083e7d85dd0aca005.js" as="script"/><link rel="preload" href="/myblog/component---src-templates-blog-post-js-55b2a1a99d1ea213b953.js" as="script"/><link rel="preload" href="/myblog/path---posts-5-1c348bc4f0bbbffb828e.js" as="script"/><link rel="preload" href="/myblog/app-df37403cdd0e6ac7ebee.js" as="script"/><link rel="preload" href="/myblog/commons-68aad81503ae45628ade.js" as="script"/><script id="webpack-manifest">/*<![CDATA[*/window.webpackManifest={"231608221292675":"app-df37403cdd0e6ac7ebee.js","107818501498521":"component---src-templates-blog-post-js-55b2a1a99d1ea213b953.js","263791100135453":"component---src-pages-about-js-ff45d29fd778b5a39075.js","35783957827783":"component---src-pages-index-js-31d5d9c1c3bd56028ef0.js","60335399758886":"path----557518bd178906f8d58a.js","81878219163735":"path---posts-3-65ce2f5b9207722d610a.js","216243879586913":"path---posts-2-f92f30ac7d2d8cb243fe.js","91246642375014":"path---posts-1-90166e225d03eda6390c.js","123118983598882":"path---posts-4-0542fcb9ca1a645193f6.js","4876863402267":"path---posts-5-1c348bc4f0bbbffb828e.js","106140644916941":"path---posts-6-654c88b5731d540ed597.js","130752015456929":"path---posts-7-f6ed77d92a2e941ca489.js","93923592088315":"path---posts-8-7cce6f2a475c28aa3699.js","20147626466865":"path---posts-9-b20d26b952031219dcce.js","142656853184902":"path---posts-10-660bb478f0dd0283a544.js","244307437753867":"path---posts-11-64142ec9824c2a7d7728.js","279941687692024":"path---posts-12-6245c00f4a64b0b54a4f.js","273950069227526":"path---about-a0e39f21c11f6a62c5ab.js","142629428675168":"path---index-cd50a25afb7a8265271e.js","114276838955818":"component---src-layouts-index-js-c1e083e7d85dd0aca005.js"}/*]]>*/</script><style type="text/css" data-styled-components="kNnBpQ iKSQLe djlcST ZZrCW cDUvTM iLZaUK jorVQO" data-styled-components-is-local="true">/* sc-component-id: sc-bdVaJa */

.kNnBpQ{height:100vh;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;}
/* sc-component-id: sc-bwzfXH */

.djlcST{-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;position:relative;}
/* sc-component-id: sc-htpNat */

.ZZrCW{position:absolute;top:0;left:0;right:0;bottom:0;}
/* sc-component-id: sc-bxivhb */

.iKSQLe{line-height:40px;padding:10px;background:#00bcd4;}.iKSQLe a{color:white;}
/* sc-component-id: sc-ifAKCX */

.jorVQO{background:#00bcd4;padding:28px;color:white;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;}.jorVQO a{color:white;display:block;padding:0px;}
/* sc-component-id: sc-EHOje */

.cDUvTM{height:100%;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;padding-top:20px;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;}.cDUvTM .markdown-content{padding:20px;-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;}
/* sc-component-id: sc-bZQynM */

.iLZaUK{font-size:20px;text-align:center;font-weight:600px;}
</style><script>/*<![CDATA[*/!function(e,t,r){function n(){for(;d[0]&&"loaded"==d[0][f];)c=d.shift(),c[o]=!i.parentNode.insertBefore(c,i)}for(var s,a,c,d=[],i=e.scripts[0],o="onreadystatechange",f="readyState";s=r.shift();)a=e.createElement(t),"async"in i?(a.async=!1,e.head.appendChild(a)):i[f]?(d.push(a),a[o]=n):e.write("<"+t+' src="'+s+'" defer></'+t+">"),a.src=s}(document,"script",["/myblog/commons-68aad81503ae45628ade.js","/myblog/app-df37403cdd0e6ac7ebee.js","/myblog/path---posts-5-1c348bc4f0bbbffb828e.js","/myblog/component---src-templates-blog-post-js-55b2a1a99d1ea213b953.js","/myblog/component---src-layouts-index-js-c1e083e7d85dd0aca005.js"])/*]]>*/</script><style id="gatsby-inlined-css">code[class*=language-],pre[class*=language-]{color:#657b83;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]::-moz-selection,code[class*=language-] ::-moz-selection,pre[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection{background:#073642}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{background:#073642}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto;border-radius:.3em}:not(pre)>code[class*=language-],pre[class*=language-]{background-color:#fdf6e3}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#93a1a1}.token.punctuation{color:#586e75}.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#268bd2}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string,.token.url{color:#2aa198}.token.entity{color:#657b83;background:#eee8d5}.token.atrule,.token.attr-value,.token.keyword{color:#859900}.token.function{color:#b58900}.token.important,.token.regex,.token.variable{color:#cb4b16}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}body{margin:0}a{text-decoration:none}*{box-sizing:border-box}</style></head><body><div id="___gatsby"><div class="sc-bdVaJa kNnBpQ" data-reactroot="" data-reactid="1" data-react-checksum="-1943968282"><div class="sc-bxivhb iKSQLe" data-reactid="2"><a href="/myblog/" data-reactid="3">首页</a></div><div class="sc-bwzfXH djlcST" data-reactid="4"><div class="sc-htpNat ZZrCW" data-reactid="5"><div class="sc-EHOje cDUvTM" data-reactid="6"><!-- react-empty: 7 --><div class="sc-bZQynM iLZaUK" data-reactid="8">五分钟为HTTP接口提供Java-Scala-SDK</div><div class="markdown-content" data-reactid="9"><blockquote>
<p>上次构建Spark 任务发布管理程序时，正好用到了两个yarn的接口。因为不想引入Yarn的client包，所以使用了他的Http接口。那么如何调用这个HTTP接口便是一个问题了</p>
</blockquote>
<h2>Case描述</h2>
<p>我现在要使用yarn的两个接口，一个是application 列表，一个是根据appId获取这个app的详情。对应的接口大约如此：</p>
<blockquote>
<p><a href="http://%5Bdns%5D/ws/v1/cluster/apps">http://[dns]/ws/v1/cluster/apps</a>
<a href="http://%5Bdns%5D/ws/v1/cluster/apps/%7BappId%7D">http://[dns]/ws/v1/cluster/apps/{appId}</a></p>
</blockquote>
<h2>基于HttpClient的初级封装</h2>
<p>基于HttpClient的一个典型封装如下：</p>
<div class="gatsby-highlight">
      <pre class="language-js"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">HttpTransportService</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> SResponse <span class="token function">post</span><span class="token punctuation">(</span>Url url<span class="token punctuation">,</span> Map data<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> SResponse <span class="token function">post</span><span class="token punctuation">(</span>Url url<span class="token punctuation">,</span> Map data<span class="token punctuation">,</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> headers<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> SResponse <span class="token function">post</span><span class="token punctuation">(</span>final Url url<span class="token punctuation">,</span> final Map data<span class="token punctuation">,</span> final int timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> SResponse <span class="token function">post</span><span class="token punctuation">(</span>final Url url<span class="token punctuation">,</span> final Map data<span class="token punctuation">,</span> final Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> headers<span class="token punctuation">,</span> final int timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> SResponse <span class="token keyword">get</span><span class="token punctuation">(</span>final Url url<span class="token punctuation">,</span> final int timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> SResponse <span class="token keyword">get</span><span class="token punctuation">(</span>Url url<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> SResponse <span class="token keyword">get</span><span class="token punctuation">(</span>Url url<span class="token punctuation">,</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> SResponse <span class="token keyword">get</span><span class="token punctuation">(</span>final Url url<span class="token punctuation">,</span> final Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> data<span class="token punctuation">,</span> final int timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> SResponse <span class="token function">put</span><span class="token punctuation">(</span>Url url<span class="token punctuation">,</span> Map data<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
      </div>
<p>更详细的代码可以参看我以前的开源项目里的实现：<a href="https://github.com/allwefantasy/ServiceFramework/blob/master/src/main/java/net/csdn/modules/transport/DefaultHttpTransportService.java">HttpTransportService.java</a></p>
<p>然而这种使用比较原始，不直观。</p>
<p>大致使用方法如下：</p>
<div class="gatsby-highlight">
      <pre class="language-js"><code>SResponse  response <span class="token operator">=</span> HttpTransportService<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Url</span><span class="token punctuation">(</span><span class="token string">"http://[dns]/ws/v1/cluster/apps/"</span><span class="token operator">+</span>appId<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>getStatus<span class="token operator">==</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">//parse result like JSONObject.parse(response.getContent())</span>
<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
<span class="token comment">//blabla</span>
<span class="token punctuation">}</span>
</code></pre>
      </div>
<p>所以一般如果提供了HTTP 接口的项目都会给你一个SDK,方便你做调用，帮你屏蔽掉HTTP的细节。</p>
<p>总体而言你有如下几种选择：</p>
<ol>
<li>直接使用上面的封装</li>
<li>使用第三方SDK</li>
<li>自己再做一些封装，转化为普通的方法调用</li>
</ol>
<p>第三种方案一般会是这样：</p>
<div class="gatsby-highlight">
      <pre class="language-js"><code>def <span class="token function">app</span><span class="token punctuation">(</span>appName<span class="token punctuation">:</span>String<span class="token punctuation">)</span><span class="token punctuation">:</span>YarnApplication <span class="token operator">=</span> <span class="token punctuation">{</span>
<span class="token comment">// 实现http接口请求解析逻辑</span>
<span class="token punctuation">}</span> 
</code></pre>
      </div>
<p>虽然麻烦了些，但是调用者会比较幸福。</p>
<h2>其实可以更简单</h2>
<p>只要三步，就可以实现第三个方案：</p>
<ol>
<li>定义一个接口</li>
<li>获取这个接口的引用</li>
<li>尽情使用</li>
</ol>
<p>定义一个接口：</p>
<div class="gatsby-highlight">
      <pre class="language-js"><code>trait <span class="token class-name">YarnController</span> <span class="token punctuation">{</span>

  @<span class="token function">At</span><span class="token punctuation">(</span>path <span class="token operator">=</span> <span class="token function">Array</span><span class="token punctuation">(</span><span class="token string">"/ws/v1/cluster/apps"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> types <span class="token operator">=</span> <span class="token function">Array</span><span class="token punctuation">(</span>RestRequest<span class="token punctuation">.</span>Method<span class="token punctuation">.</span>GET<span class="token punctuation">)</span><span class="token punctuation">)</span>
  def <span class="token function">apps</span><span class="token punctuation">(</span>@<span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">"states"</span><span class="token punctuation">)</span> states<span class="token punctuation">:</span> String<span class="token punctuation">)</span><span class="token punctuation">:</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>List<span class="token punctuation">[</span>HttpTransportService<span class="token punctuation">.</span>SResponse<span class="token punctuation">]</span>

  @<span class="token function">At</span><span class="token punctuation">(</span>path <span class="token operator">=</span> <span class="token function">Array</span><span class="token punctuation">(</span><span class="token string">"/ws/v1/cluster/apps/{appId}"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> types <span class="token operator">=</span> <span class="token function">Array</span><span class="token punctuation">(</span>RestRequest<span class="token punctuation">.</span>Method<span class="token punctuation">.</span>GET<span class="token punctuation">)</span><span class="token punctuation">)</span>
  def <span class="token function">app</span><span class="token punctuation">(</span>@<span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">"appId"</span><span class="token punctuation">)</span> appId<span class="token punctuation">:</span> String<span class="token punctuation">)</span><span class="token punctuation">:</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>List<span class="token punctuation">[</span>HttpTransportService<span class="token punctuation">.</span>SResponse<span class="token punctuation">]</span>

<span class="token punctuation">}</span>
</code></pre>
      </div>
<p>At 注解定义了 path路径以及Action Method。 方法参数决定了传递的参数。</p>
<p>对于同一个http接口，你也可以定义多个方法。比如，</p>
<div class="gatsby-highlight">
      <pre class="language-js"><code>trait <span class="token class-name">YarnController</span> <span class="token punctuation">{</span>

  @<span class="token function">At</span><span class="token punctuation">(</span>path <span class="token operator">=</span> <span class="token function">Array</span><span class="token punctuation">(</span><span class="token string">"/ws/v1/cluster/apps"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> types <span class="token operator">=</span> <span class="token function">Array</span><span class="token punctuation">(</span>RestRequest<span class="token punctuation">.</span>Method<span class="token punctuation">.</span>GET<span class="token punctuation">)</span><span class="token punctuation">)</span>
  def <span class="token function">apps</span><span class="token punctuation">(</span>@<span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">"states"</span><span class="token punctuation">)</span> states<span class="token punctuation">:</span> String<span class="token punctuation">)</span><span class="token punctuation">:</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>List<span class="token punctuation">[</span>HttpTransportService<span class="token punctuation">.</span>SResponse<span class="token punctuation">]</span>

  @<span class="token function">At</span><span class="token punctuation">(</span>path <span class="token operator">=</span> <span class="token function">Array</span><span class="token punctuation">(</span><span class="token string">"/ws/v1/cluster/apps"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> types <span class="token operator">=</span> <span class="token function">Array</span><span class="token punctuation">(</span>RestRequest<span class="token punctuation">.</span>Method<span class="token punctuation">.</span>GET<span class="token punctuation">)</span><span class="token punctuation">)</span>
  def <span class="token function">runningApps</span><span class="token punctuation">(</span>@<span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">"states"</span><span class="token punctuation">)</span> states<span class="token punctuation">:</span> String<span class="token operator">=</span><span class="token string">"running"</span><span class="token punctuation">)</span><span class="token punctuation">:</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>List<span class="token punctuation">[</span>HttpTransportService<span class="token punctuation">.</span>SResponse<span class="token punctuation">]</span>

<span class="token punctuation">}</span>
</code></pre>
      </div>
<p>这样你直接调用runningApps 就可以拿到特定状态的应用，而无需传递参数。如果参数较多，你还可以指定哪些参数不传，哪些传。</p>
<p>接着初始化 YarnController，获得对象的引用，代码如下：</p>
<div class="gatsby-highlight">
      <pre class="language-js"><code>val yarnRestClient<span class="token punctuation">:</span> YarnController <span class="token operator">=</span> 
AggregateRestClient<span class="token punctuation">.</span>buildIfPresent<span class="token punctuation">[</span>YarnController<span class="token punctuation">]</span>
<span class="token punctuation">(</span>hostAndPort<span class="token punctuation">,</span> 
firstMeetProxyStrategy<span class="token punctuation">,</span> 
RestClient<span class="token punctuation">.</span>transportService<span class="token punctuation">)</span>
</code></pre>
      </div>
<ul>
<li>hostAndPort 是yarn的地址</li>
<li>firstMeetProxyStrategy 指定如果后端有多个实例时的访问策略</li>
<li>RestClient.transportService 就是我上面的最基础的封装HttpTransportService</li>
</ul>
<p>理论上后面两个参数可以不用传递</p>
<p>这个时候你就可以直接使用获得的<code>YarnController</code>对象了。具体使用方式如下：</p>
<div class="gatsby-highlight">
      <pre class="language-none"><code>val result:java.util.List[HttpTransportService.SResponse] = yarnRestClient.apps()  </code></pre>
      </div>
<p>上面就是你要做的所有工作，系统自动帮你实现了HTTP调用。</p>
<h2>我希望返回结果是一个Bean</h2>
<p>前面的放回结果是个List[SResponse]对象。我希望它是个Bean对象。所以我定义一个Bean类：</p>
<div class="gatsby-highlight">
      <pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">YarnApplication</span><span class="token punctuation">(</span>val id<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
                            <span class="token keyword">var</span> user<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
                            <span class="token keyword">var</span> name<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
                            <span class="token keyword">var</span> queue<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
                            <span class="token keyword">var</span> state<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
                            <span class="token keyword">var</span> finalStatus<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
                            <span class="token keyword">var</span> progress<span class="token punctuation">:</span> Long<span class="token punctuation">,</span>
                            <span class="token keyword">var</span> trackingUI<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
                            <span class="token keyword">var</span> trackingUrl<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
                            <span class="token keyword">var</span> diagnostics<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
                            <span class="token keyword">var</span> clusterId<span class="token punctuation">:</span> Long<span class="token punctuation">,</span>
                            <span class="token keyword">var</span> applicationType<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
                            <span class="token keyword">var</span> applicationTags<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
                            <span class="token keyword">var</span> startedTime<span class="token punctuation">:</span> Long<span class="token punctuation">,</span>
                            <span class="token keyword">var</span> finishedTime<span class="token punctuation">:</span> Long<span class="token punctuation">,</span>
                            <span class="token keyword">var</span> elapsedTime<span class="token punctuation">:</span> Long<span class="token punctuation">,</span>
                            <span class="token keyword">var</span> amContainerLogs<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
                            <span class="token keyword">var</span> amHostHttpAddress<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
                            <span class="token keyword">var</span> allocatedMB<span class="token punctuation">:</span> Long<span class="token punctuation">,</span>
                            <span class="token keyword">var</span> allocatedVCores<span class="token punctuation">:</span> Long<span class="token punctuation">,</span>
                            <span class="token keyword">var</span> runningContainers<span class="token punctuation">:</span> Long<span class="token punctuation">,</span>
                            <span class="token keyword">var</span> memorySeconds<span class="token punctuation">:</span> Long<span class="token punctuation">,</span>
                            <span class="token keyword">var</span> vcoreSeconds<span class="token punctuation">:</span> Long<span class="token punctuation">,</span>
                            <span class="token keyword">var</span> preemptedResourceMB<span class="token punctuation">:</span> Long<span class="token punctuation">,</span>
                            <span class="token keyword">var</span> preemptedResourceVCores<span class="token punctuation">:</span> Long<span class="token punctuation">,</span>
                            <span class="token keyword">var</span> numNonAMContainerPreempted<span class="token punctuation">:</span> Long<span class="token punctuation">,</span>
                            <span class="token keyword">var</span> numAMContainerPreempted<span class="token punctuation">:</span> Long<span class="token punctuation">)</span>
</code></pre>
      </div>
<p>然后引入一个隐式转换</p>
<div class="gatsby-highlight">
      <pre class="language-js"><code><span class="token keyword">import</span> <span class="token operator">...</span><span class="token punctuation">.</span><span class="token punctuation">.</span> SReponseConvertor <span class="token punctuation">.</span>_
val result<span class="token punctuation">:</span>Map<span class="token punctuation">[</span>Map<span class="token punctuation">[</span>String<span class="token punctuation">,</span>List<span class="token punctuation">[</span>YarnApplication<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">=</span> yarnRestClient<span class="token punctuation">.</span><span class="token function">apps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extract<span class="token punctuation">[</span>Map<span class="token punctuation">[</span>Map<span class="token punctuation">[</span>String<span class="token punctuation">,</span>List<span class="token punctuation">[</span>YarnApplication<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span> 

<span class="token function">result</span><span class="token punctuation">(</span><span class="token string">"apps"</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">"app"</span><span class="token punctuation">)</span> <span class="token comment">//这样就能拿到List[YarnApplication]</span>
</code></pre>
      </div>
<p>SReponseConvertor 给List[SReponse]对象添加了一个新的extract 方法。当然前提是List[SReponse] 里是一个JSON格式的数据。</p>
<p>因为yarn的接口返回的格式比较诡异，嵌套了两层，第一层是apps,第二层是app,第三层才是具体的List对象。所以有了上面的复杂形态。那我如何简化呢？每次调用都这么搞，太复杂了。</p>
<p>那么自己实现一个隐式转换就行了，定义一个YarnControllerE类，</p>
<div class="gatsby-highlight">
      <pre class="language-js"><code>object YarnControllerE <span class="token punctuation">{</span>
  implicit def <span class="token function">mapSResponseToObject</span><span class="token punctuation">(</span>response<span class="token punctuation">:</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>List<span class="token punctuation">[</span>HttpTransportService<span class="token punctuation">.</span>SResponse<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span> SResponseEnhance <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">new</span> <span class="token class-name">SResponseEnhance</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">import</span> scala<span class="token punctuation">.</span>collection<span class="token punctuation">.</span>JavaConversions<span class="token punctuation">.</span>_

<span class="token keyword">class</span> <span class="token class-name">SResponseEnhance</span><span class="token punctuation">(</span>x<span class="token punctuation">:</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>List<span class="token punctuation">[</span>HttpTransportService<span class="token punctuation">.</span>SResponse<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token keyword">private</span> def extract<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">(</span>res<span class="token punctuation">:</span> String<span class="token punctuation">)</span><span class="token punctuation">(</span>implicit manifest<span class="token punctuation">:</span> Manifest<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span> T <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> x<span class="token punctuation">.</span>isEmpty <span class="token operator">||</span> <span class="token function">x</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getStatus <span class="token operator">!=</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">.</span>asInstanceOf<span class="token punctuation">[</span>T<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
    implicit val formats <span class="token operator">=</span> SJSon<span class="token punctuation">.</span>DefaultFormats
    SJSon<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">.</span>extract<span class="token punctuation">[</span>T<span class="token punctuation">]</span>
  <span class="token punctuation">}</span>


  def <span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> List<span class="token punctuation">[</span>YarnApplication<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    val item <span class="token operator">=</span> extract<span class="token punctuation">[</span>Map<span class="token punctuation">[</span>String<span class="token punctuation">,</span> Map<span class="token punctuation">[</span>String<span class="token punctuation">,</span> List<span class="token punctuation">[</span>YarnApplication<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getContent<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token function">item</span><span class="token punctuation">(</span><span class="token string">"apps"</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">"app"</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre>
      </div>
<p>现在你可以很帅气这样调用了：</p>
<div class="gatsby-highlight">
      <pre class="language-none"><code>import ..... YarnControllerE ._
val result: List[YarnApplication] = yarnRestClient.apps().list</code></pre>
      </div>
<p>这样我们就可以像RPC一样访问一个HTTP接口了。</p>
<h2>背后的机制</h2>
<p>核心代码其实是这个：</p>
<div class="gatsby-highlight">
      <pre class="language-js"><code>val yarnRestClient<span class="token punctuation">:</span> YarnController <span class="token operator">=</span> 
AggregateRestClient<span class="token punctuation">.</span>buildIfPresent<span class="token punctuation">[</span>YarnController<span class="token punctuation">]</span>
<span class="token punctuation">(</span>hostAndPort<span class="token punctuation">,</span> 
firstMeetProxyStrategy<span class="token punctuation">,</span> 
RestClient<span class="token punctuation">.</span>transportService<span class="token punctuation">)</span>
</code></pre>
      </div>
<p>AggregateRestClient 会帮你把YarnController 自动实现了。实现的机制很简单就是 JDK 的 Proxy机制。具体源码可以参看:<a href="https://github.com/allwefantasy/ServiceFramework/blob/master/src/main/java/net/csdn/modules/transport/proxy/AggrateRestClient.scala">AggrateRestClient.scala</a> 以及<a href="https://github.com/allwefantasy/ServiceFramework/blob/master/src/main/java/com/alibaba/dubbo/rpc/protocol/rest/RestClientProxy.java">RestClientProxy.java</a></p></div><div class="sc-ifAKCX jorVQO" data-reactid="10"><div data-reactid="11"><a href="/myblog/posts/4" data-reactid="12">Prev</a></div><div data-reactid="13"><a href="/myblog/posts/6" data-reactid="14">Next</a></div></div></div></div></div></div></div></body></html>